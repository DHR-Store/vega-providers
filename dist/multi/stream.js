"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=getStream;const DEFAULT_HEADERS={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","X-Requested-With":"XMLHttpRequest"},GDMIRROR_DOMAINS=["gdmirrorbot.nl","stream.techinmind.space"],PACKED_DOMAINS=["allinonedownloader.fun","dhcplay.com","multimovies.cloud","animezia.cloud","server2.shop","asnwish.com","cdnwish.com","strwish.com"],VIDSTACK_DOMAINS=["server1.uns.bio"];function base64Decode(str){try{return"function"==typeof atob?atob(str):Buffer.from(str,"base64").toString("utf-8")}catch(e){return""}}function unpack(p,a,c,k){for(;c--;)if(k[c]){const regex=new RegExp("\\b"+c.toString(a)+"\\b","g");p=p.replace(regex,k[c])}return p}function isDomain(url,domains){try{const hostname=new URL(url).hostname;return domains.some(d=>hostname.includes(d))}catch(e){return!1}}async function extractPacked(url,referer,axios){try{const html=(await axios.get(url,{headers:{Referer:referer}})).data,match=/eval\(function\(p,a,c,k,e,d\)\{.*?return p\}\('(.*?)',(\d+),(\d+),'(.*?)'\.split\('\|'\)/.exec(html);if(match){const unpacked=unpack(match[1],parseInt(match[2]),parseInt(match[3]),match[4].split("|")),m3u8Match=/file:\s*"([^"]+\.m3u8[^"]*)"/.exec(unpacked);if(m3u8Match)return m3u8Match[1]}const fileMatch=/file:\s*"([^"]+\.m3u8[^"]*)"/.exec(html);if(fileMatch)return fileMatch[1]}catch(e){}return null}async function extractGDMirror(url,axios){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k;const streams=[];try{let host="",sid="",targetUrl=url;if(!targetUrl.includes("embed/")&&!targetUrl.includes("key="))try{targetUrl=(await axios.head(targetUrl,{maxRedirects:3})).request.res.responseUrl||targetUrl}catch(e){}if(targetUrl.includes("key="))try{const html=(await axios.get(targetUrl)).data,finalId=null===(_a=/FinalID\s*=\s*"([^"]+)"/.exec(html))||void 0===_a?void 0:_a[1],myKey=null===(_b=/myKey\s*=\s*"([^"]+)"/.exec(html))||void 0===_b?void 0:_b[1],idType=(null===(_c=/idType\s*=\s*"([^"]+)"/.exec(html))||void 0===_c?void 0:_c[1])||"imdbid",baseUrl=null===(_d=/let\s+baseUrl\s*=\s*"([^"]+)"/.exec(html))||void 0===_d?void 0:_d[1];if(host=baseUrl||new URL(targetUrl).origin,finalId&&myKey){const apiRes=await axios.get(`${host}/mymovieapi?${idType}=${finalId}&key=${myKey}`);(null===(_g=null===(_f=null===(_e=apiRes.data)||void 0===_e?void 0:_e.data)||void 0===_f?void 0:_f[0])||void 0===_g?void 0:_g.fileslug)&&(sid=apiRes.data.data[0].fileslug)}}catch(e){}if(!sid&&targetUrl.includes("/embed/")&&(sid=targetUrl.split("/embed/")[1].split(/[\?#]/)[0],host=new URL(targetUrl).origin),!sid||!host)return[];const data=(await axios.post(`${host}/embedhelper.php`,new URLSearchParams({sid:sid}).toString(),{headers:{Referer:targetUrl,...DEFAULT_HEADERS,"Content-Type":"application/x-www-form-urlencoded"}})).data;if(data.siteUrls&&data.mresult){let decodedMresult={};try{decodedMresult=JSON.parse(base64Decode(data.mresult))}catch(e){decodedMresult=data.mresult}for(const key of Object.keys(data.siteUrls)){const base=null===(_h=data.siteUrls[key])||void 0===_h?void 0:_h.replace(/\/$/,""),path=null===(_j=decodedMresult[key])||void 0===_j?void 0:_j.replace(/^\//,"");if(base&&path){const fullUrl=`${base}/${path}`,friendlyName=(null===(_k=data.siteFriendlyNames)||void 0===_k?void 0:_k[key])||key,m3u8=await extractPacked(fullUrl,host,axios);streams.push({server:friendlyName||"Server",link:m3u8||fullUrl,type:m3u8?"m3u8":"mp4"})}}}}catch(e){}return streams}async function getStream({link:link,providerContext:providerContext}){var _a,_b,_c,_d;const{axios:axios}=providerContext,streams=[];try{const baseUrl=new URL(link).origin,headers={...DEFAULT_HEADERS,Referer:baseUrl},html=(await axios.get(link,{headers:headers})).data,liRegex=/<li\s+[^>]*class=["'].*?dooplay_player_option.*?["'][^>]*>/g,servers=[];let match;for(;null!==(match=liRegex.exec(html));){const li=match[0],post=null===(_a=/data-post=["']([^"']+)["']/.exec(li))||void 0===_a?void 0:_a[1],nume=null===(_b=/data-nume=["']([^"']+)["']/.exec(li))||void 0===_b?void 0:_b[1],type=null===(_c=/data-type=["']([^"']+)["']/.exec(li))||void 0===_c?void 0:_c[1];post&&nume&&type&&servers.push({post:post,nume:nume,type:type})}if(0===servers.length){const iframeMatch=/<iframe[^>]+src=["']([^"']+)["']/g;for(;null!==(match=iframeMatch.exec(html));)servers.push({post:"iframe",nume:"Direct",type:"iframe",url:match[1]})}for(const server of servers){const serverName=server.nume||"Server";if(!serverName.toLowerCase().includes("trailer"))try{let embedUrl=server.url||"";if(!embedUrl&&"iframe"!==server.post){const params=new URLSearchParams;params.append("action","doo_player_ajax"),params.append("post",server.post||""),params.append("nume",server.nume||""),params.append("type",server.type||"");embedUrl=(null===(_d=(await axios.post(`${baseUrl}/wp-admin/admin-ajax.php`,params.toString(),{headers:{...headers,"Content-Type":"application/x-www-form-urlencoded"}})).data)||void 0===_d?void 0:_d.embed_url)||""}if(!embedUrl)continue;if(embedUrl=embedUrl.replace(/\\"/g,"").replace(/"/g,"").trim(),embedUrl.includes("streamcasthub")){const id=embedUrl.split("/#")[1];id&&streams.push({server:"StreamCastHub",link:`https://ss1.rackcloudservice.cyou/ic/${id}/master.txt`,type:"m3u8",headers:{Referer:embedUrl}})}else if(isDomain(embedUrl,GDMIRROR_DOMAINS)){const gdStreams=await extractGDMirror(embedUrl,axios);streams.push(...gdStreams)}else if(embedUrl.includes("deaddrive.xyz")){const ddRes=await axios.get(embedUrl),vidMatch=/data-video=["']([^"']+)["']/g;let vm;for(;null!==(vm=vidMatch.exec(ddRes.data));){const vidUrl=vm[1];if(isDomain(vidUrl,GDMIRROR_DOMAINS))streams.push(...await extractGDMirror(vidUrl,axios));else{const m3u8=await extractPacked(vidUrl,embedUrl,axios);streams.push({server:"DeadDrive",link:m3u8||vidUrl,type:m3u8?"m3u8":"mp4"})}}}else if(isDomain(embedUrl,VIDSTACK_DOMAINS)){const m3u8=await extractPacked(embedUrl,baseUrl,axios);streams.push({server:serverName,link:m3u8||embedUrl,type:m3u8?"m3u8":"mp4"})}else if(isDomain(embedUrl,PACKED_DOMAINS)){const m3u8=await extractPacked(embedUrl,baseUrl,axios);m3u8?streams.push({server:serverName,link:m3u8,type:"m3u8"}):streams.push({server:serverName,link:embedUrl,type:"mp4"})}else if(embedUrl.includes(".m3u8"))streams.push({server:serverName,link:embedUrl,type:"m3u8"});else{const m3u8=await extractPacked(embedUrl,baseUrl,axios);streams.push({server:serverName,link:m3u8||embedUrl,type:m3u8?"m3u8":"mp4"})}}catch(e){}}}catch(err){}return streams}