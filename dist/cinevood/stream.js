"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStream=getStream;const DEFAULT_HEADERS={Referer:"https://strmup.to/","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"},URL_REGEX=/https?:\/\/[^\s'"]{10,500}/g,PREFERRED_PATTERNS=[/\.m3u8(\?|$)/i,/\.mp4(\?|$)/i,/drive\.google\.com/i,/gofile\.io/i,/mega\.nz/i,/mediafire\.com/i,/dood\.watch|doodstream/i,/filemoon\.ws|filemoon\.to/i,/streamlare\.com/i];function pickBest(urls){if(!urls||0===urls.length)return null;for(const p of PREFERRED_PATTERNS){const found=urls.find(u=>p.test(u));if(found)return found}return urls.find(u=>/\.(mp4|mkv|avi)(\?|$)/i.test(u))||urls[0]||null}async function extractUrlsFromText(text){const found=new Set;return(text.match(URL_REGEX)||[]).forEach(raw=>{let u=raw.replace(/[)"'\]}]+$/,"");u=u.replace(/^[('"[]+/,""),u.length>10&&u.length<2e3&&found.add(u)}),Array.from(found)}async function fetchAndExtract(axios,url,signal){var _a,_b,_c;try{const res=await axios.get(url,{headers:DEFAULT_HEADERS,maxRedirects:5,timeout:15e3,signal:signal,responseType:"text",validateStatus:s=>s>=200&&s<400}),body=String(res.data||"");return{urls:await extractUrlsFromText(body),finalUrl:(null===(_b=null===(_a=res.request)||void 0===_a?void 0:_a.res)||void 0===_b?void 0:_b.responseUrl)||(null===(_c=res.request)||void 0===_c?void 0:_c.responseURL)||url,body:body}}catch(err){return{urls:[],finalUrl:url,body:""}}}async function getStream({link:link,signal:signal,providerContext:providerContext,streamType:streamType}){const{axios:axios}=providerContext;try{if(!link)return[];if(/\.(m3u8)(\?|$)/i.test(link))return[{url:link,type:"hls",quality:"auto"}];if(/\.(mp4|mkv|avi)(\?|$)/i.test(link))return[{url:link,type:"direct",quality:"auto"}];const first=await fetchAndExtract(axios,link,signal);let candidates=first.urls||[];if(0===candidates.length){const iframeSrcs=Array.from(String(first.body||"").matchAll(/<iframe[^>]+src\s*=\s*['"]([^'"]+)['"]/gi)).map(m=>m[1]);for(const s of iframeSrcs){const resolved=s.startsWith("http")?s:new URL(s,first.finalUrl).href,second=await fetchAndExtract(axios,resolved,signal);if(candidates=candidates.concat(second.urls||[]),candidates.length)break}}candidates=Array.from(new Set(candidates));let best=pickBest(candidates);if(!best&&first.finalUrl&&first.finalUrl!==link){const f2=await fetchAndExtract(axios,first.finalUrl,signal);candidates=candidates.concat(f2.urls||[]),candidates=Array.from(new Set(candidates)),best=pickBest(candidates)}if(best&&!/\.(m3u8|mp4|mkv|avi|zip)(\?|$)/i.test(best)&&!/drive\.google\.com|mega\.nz|mediafire\.com|gofile\.io/i.test(best)){const deeper=await fetchAndExtract(axios,best,signal),pick=pickBest(Array.from(new Set(candidates.concat(deeper.urls||[]))));pick&&(best=pick)}if(!best&&candidates.length>0&&(best=candidates[0]),!best)return[];if(best.includes(".m3u8")){try{await axios.head(best,{headers:{...DEFAULT_HEADERS,Referer:link},timeout:1e4,maxRedirects:5})}catch(_a){}return[{url:best,type:"hls",quality:"auto"}]}return/\.(mp4|mkv|avi)(\?|$)/i.test(best)?[{url:best,type:"direct",quality:"auto"}]:[{url:best,type:"host",quality:"auto"}]}catch(err){return[]}}